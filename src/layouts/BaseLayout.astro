---
import "../styles/global.css";

const {
  title = "Life Coaching & Web Design for Small Businesses | Elevate Your Divine",
  description = "Life coaching, bariatric coaching, and modern single-page web design for small businesses. Build clarity, confidence, and an online presence that converts.",
} = Astro.props;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta
      property="og:title"
      content="Elevate Your Divine â€” Life Coaching & Web Design"
    />
    <meta
      property="og:description"
      content="Life coaching, bariatric coaching, and modern web design to help you grow with clarity and confidence."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://elevateyourdivine.com" />
    <meta
      property="og:image"
      content="https://elevateyourdivine.com/images/og-image.jpg"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="description" content={description} />
    <title>{title}</title>
  </head>

  <body
    class="min-h-screen bg-gradient-to-bl from-zinc-900 via-zinc-800 to-zinc-300 text-white antialiased"
  >
    <slot />

    <script is:inline>
      let hasUserNavigated = false;
      const FADE_MS = 300;

      const ALIASES = {
        // Backwards compatibility (old targets/hashes)
        services: "home",
        program: "coaching",
        "program:coaching": "coaching",
        "program:web": "web",
      };

      function normalizeTarget(rawTarget) {
        const raw = String(rawTarget || "").replace(/^#/, "");

        // Map legacy values
        if (ALIASES[raw]) return ALIASES[raw];

        // If someone deep-links like #program:web, map it
        if (raw.startsWith("program:")) {
          const mapped = ALIASES[raw];
          return mapped || "coaching";
        }

        // Allowed new targets
        const allowed = new Set([
          "home",
          "coaching",
          "web",
          "about",
          "contact",
        ]);
        if (allowed.has(raw)) return raw;

        return "home";
      }

      function setActiveNav(target) {
        const buttons = document.querySelectorAll("[data-nav]");
        buttons.forEach((b) => {
          // Don't apply active-ring styling to the logo button
          if (b.hasAttribute("data-nav-logo")) {
            b.setAttribute("aria-current", "false");
            b.classList.remove("ring-2", "ring-white/30");
            return;
          }

          const isActive = b.getAttribute("data-target") === target;
          b.setAttribute("aria-current", isActive ? "page" : "false");
          b.classList.toggle("ring-2", isActive);
          b.classList.toggle("ring-white/30", isActive);
        });
      }

      function fadeOut(el) {
        if (!el || el.classList.contains("hidden")) return;
        el.classList.add("opacity-0");
        el.classList.remove("opacity-100");
      }

      function hideEl(el) {
        if (!el) return;
        el.classList.add("hidden");
      }

      function showEl(el) {
        if (!el) return;
        el.classList.remove("hidden");
        el.classList.add("opacity-0");
        requestAnimationFrame(() => {
          el.classList.remove("opacity-0");
          el.classList.add("opacity-100");
        });
      }

      function ensureHash(target) {
        if (!hasUserNavigated && !location.hash) return;
        history.replaceState(null, "", `#${target}`);
      }

      function showSection(rawTarget) {
        const target = normalizeTarget(rawTarget);

        const hero = document.querySelector("[data-hero]");
        const sections = Array.from(
          document.querySelectorAll("[data-section]"),
        );
        const next = document.querySelector(`[data-section="${target}"]`);

        if (!next) return;

        const current =
          sections.find((s) => !s.classList.contains("hidden")) || null;

        const shouldShowHero = target === "home";
        const heroIsVisible = hero && !hero.classList.contains("hidden");

        // If nothing changes, still update nav + hash
        if (current === next) {
          setActiveNav(target);
          // Hero visibility might still need to change
          if (hero) {
            if (shouldShowHero && !heroIsVisible) showEl(hero);
            if (!shouldShowHero && heroIsVisible) {
              fadeOut(hero);
              setTimeout(() => hideEl(hero), FADE_MS);
            }
          }
          ensureHash(target);
          return;
        }

        setActiveNav(target);

        // Start fades
        if (current) fadeOut(current);
        if (hero) {
          if (!shouldShowHero && heroIsVisible) fadeOut(hero);
        }

        setTimeout(() => {
          // Hide old section
          if (current) hideEl(current);

          // Hide hero if needed
          if (hero && !shouldShowHero && heroIsVisible) hideEl(hero);

          // Show next section
          showEl(next);

          // Show hero if needed
          if (hero && shouldShowHero && !heroIsVisible) showEl(hero);
        }, FADE_MS);

        ensureHash(target);
      }

      // Click-based navigation
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-nav]");
        if (!btn) return;

        hasUserNavigated = true;

        const target = btn.getAttribute("data-target");
        const scrollMode = btn.getAttribute("data-scroll"); // optional: "services" | "top" | null
        if (!target) return;

        showSection(target);

        // Always scroll after a view change unless explicitly scrolling to Services.
        // This fixes "staying at bottom" when switching sections.
        setTimeout(() => {
          if (scrollMode === "services") {
            const el = document.querySelector('[data-section="home"]');
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            return;
          }

          // Home should go to the top (Hero), not the services section
          if (target === "home") {
            window.scrollTo({ top: 0, behavior: "smooth" });
            return;
          }

          // For every other section change: scroll to top so the user sees the section header
          window.scrollTo({ top: 0, behavior: "smooth" });
        }, FADE_MS + 30);
      });

      // Hash-based navigation (deep links)
      window.addEventListener("hashchange", () => {
        const raw = location.hash.replace("#", "");
        showSection(raw || "home");
      });

      // Initial load
      window.addEventListener("DOMContentLoaded", () => {
        const initial = (location.hash || "#home").replace("#", "");
        showSection(initial);
      });
    </script>
  </body>
</html>
